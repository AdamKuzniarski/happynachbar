# Backend - Roles & RBAC (user/moderator/admin)

## Summary

Introduce role-based access control (RBAC) with three roles `USER`, `MODERATOR`, `ADMIN`. Store role on `User`, include role in JWT auth context, and enforce access via a NestJS guard + decorator. Add at least one protected endpoint as proof.

## Tasks

- [ ] DB / Prisma
  - Add enum: `UserRole { USER MODERATOR ADMIN}`
  - Add `User.role: UserRole @default(USER)`
  - Run migration
- [ ] Auth/JWT
  - Include `role` in JWT payload at login/issue time.
  - Ensure `JwtStrategy.validate()` attaches `role` to `req.user`
- [ ] RBAC Infrastructure
  - Implement `@Roles(...roles)` decorator.
  - Implement `RolesGuard`:
    - Reads allowed roles form metadata
    - Checks `req.user.role`
    - Returns 403 when insufficient
- [ ] Protected Route (test/example)
  - Add simple test route like `GET /admin/ping` protected by `@Roles(ADMIN)`
  - Add simple test route like `GET /moderator/ping` protected by `@Roles(MODERATOR)`
- [ ] Safety tests
  - Ensure users cannot change their own role via `PATCH /users/me` or any public endpoint.
  - Role update should be admin-only.

## Acceptance Criteria

- [ ] `User.role` exists with default `USER` for new and existing users.
- [ ] JWT auth context exposes `req.user.role`.
- [Â ] `@Roles` + `RolesGuard`are implemented and applied.
- [ ] `GET /admin/ping`:
  - returns `200` for `ADMIN`
  - return `403` for `USER / Moderator`
- [ ] No public "me" update endpoint can modify `role`.
